<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AI Personal Expense Categorizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet">
    <style>
        body { background-color: #f5f7fb; }
        .card { box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .section { display: none; }
        .section.active { display: block; }
    </style>
</head>
<body>
<div class="container py-4">

    <!-- Top bar with user info -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 mb-0">AI Personal Expense Categorizer</h1>
        {% if user %}
        <div class="d-flex align-items-center gap-3">
            <span class="text-muted">
                Logged in as <strong>{{ user["email"] }}</strong>
            </span>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary btn-sm">Logout</a>
        </div>
        {% endif %}
    </div>

    <div class="d-flex justify-content-center gap-3 mb-4">
        <button id="btn-add" class="btn btn-primary btn-lg">
            Add New Expense
        </button>
        <button id="btn-summary" class="btn btn-outline-secondary btn-lg">
            Monthly Spent Data
        </button>
    </div>

        <!-- Month selector -->
    <form method="get" class="mb-3">
      <div class="row g-2 align-items-center">
        <div class="col-auto">
          <label for="month" class="col-form-label">Show expenses for:</label>
        </div>
        <div class="col-auto">
          <select id="month" name="month" class="form-select form-select-sm">
            <option value="this" {% if selected_month == 'this' %}selected{% endif %}>This month</option>
            <option value="last" {% if selected_month == 'last' %}selected{% endif %}>Last month</option>
            <option value="all" {% if selected_month == 'all' %}selected{% endif %}>All time</option>
          </select>
        </div>
        <div class="col-auto">
          <button type="submit" class="btn btn-sm btn-primary">Apply</button>
        </div>
      </div>
    </form>


    <!-- Add Expense section -->
    <div id="section-add" class="section">
        <div class="card mb-4">
            <div class="card-header fw-semibold">Add Expense</div>
            <div class="card-body">

                {% if error %}
                <div class="alert alert-danger">
                    {{ error }}
                </div>
                {% endif %}

                {% if message %}
                <div class="alert alert-success">
                    {{ message }}
                </div>
                {% endif %}

                <!-- Free-text input -->
                <form method="POST" action="/" class="mb-3">
                    <input type="hidden" name="form_type" value="text">
                    <div class="mb-3">
                        <label class="form-label">Expense description (free text)</label>
                        <input type="text"
                               class="form-control"
                               name="description"
                               placeholder="spent 200 for cappuccino">
                    </div>
                    <button type="submit" class="btn btn-success">
                        Save (free text)
                    </button>
                </form>

                <!-- Button to reveal structured form -->
                <button id="btn-show-structured"
                        type="button"
                        class="btn btn-outline-primary mb-3">
                    Add with amount &amp; item
                </button>

                <!-- Structured form (initially hidden) -->
                <div id="structured-wrapper" style="display:none;">
                    <hr class="my-4">
                    <h5>Add with amount &amp; item</h5>
                    <form method="POST" action="/">
                        <input type="hidden" name="form_type" value="structured">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Amount</label>
                                <input type="number" step="0.01" min="0"
                                       class="form-control" name="amount"
                                       placeholder="200" required>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">Item / description</label>
                                <input type="text"
                                       class="form-control"
                                       name="item"
                                       placeholder="cappuccino" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Category (optional)</label>
                                <select class="form-select" name="category_override">
                                    <option value="">Auto detect</option>
                                    <option value="Food">Food</option>
                                    <option value="Bills">Bills</option>
                                    <option value="Shopping">Shopping</option>
                                    <option value="Transport">Transport</option>
                                    <option value="Rent">Rent</option>
                                    <option value="Entertainment">Entertainment</option>
                                    <option value="Health">Health</option>
                                    <option value="Education">Education</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3">
                            Save (structured)
                        </button>
                    </form>
                </div>

            </div>
        </div>

        <div class="card">
            <div class="card-header fw-semibold">Recent Expenses</div>
            <div class="card-body p-0">
                <table class="table table-striped mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Category</th>
                            <th>Date</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for row in recent %}
                        <tr>
                            <td>{{ row[1] }}</td>
                            <td>{{ "%.2f"|format(row[2]) }}</td>
                            <td>{{ row[3] }}</td>
                            <td>{{ row[4] }}</td>
                            <td>
                                <form method="POST" action="/delete/{{ row[0] }}"
                                      onsubmit="return confirm('Delete this expense?');">
                                    <button type="submit"
                                            class="btn btn-sm btn-outline-danger">
                                        ðŸ—‘
                                    </button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Monthly summary section -->
    <div id="section-summary" class="section">
        <div class="card mb-4">
            <div class="card-header fw-semibold">Monthly Category-wise Spend</div>
            <div class="card-body">
                <div class="row g-4 align-items-start">
                    <div class="col-md-5">
                        <canvas id="monthlyChart" height="200"></canvas>
                    </div>
                    <div class="col-md-7">
                        <div class="table-responsive">
                            <table class="table table-striped mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Category</th>
                                        <th>Total Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for cat, total in category_totals.items() %}
                                    <tr>
                                        <td>{{ cat }}</td>
                                        <td>{{ "%.2f"|format(total) }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-0">
    Overall total {% if selected_month == 'this' %}this month{% elif selected_month == 'last' %}last month{% else %}all time{% endif %}: 

                    <span class="text-primary">
                        {{ "%.2f"|format(overall_total) }}
                    </span>
                </h5>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    const sectionAdd = document.getElementById('section-add');
    const sectionSummary = document.getElementById('section-summary');
    const btnAdd = document.getElementById('btn-add');
    const btnSummary = document.getElementById('btn-summary');

    function showAdd() {
        sectionAdd.classList.add('active');
        sectionSummary.classList.remove('active');
        btnAdd.classList.remove('btn-outline-secondary');
        btnAdd.classList.add('btn-primary');
        btnSummary.classList.remove('btn-primary');
        btnSummary.classList.add('btn-outline-secondary');
    }

    function showSummary() {
        sectionSummary.classList.add('active');
        sectionAdd.classList.remove('active');
        btnSummary.classList.remove('btn-outline-secondary');
        btnSummary.classList.add('btn-primary');
        btnAdd.classList.remove('btn-primary');
        btnAdd.classList.add('btn-outline-secondary');
    }

    // Preserve month filter when switching tabs
btnAdd.addEventListener('click', function() {
    showAdd();
    const month = new URLSearchParams(window.location.search).get('month') || 'this';
    window.history.replaceState({}, '', `/?month=${month}`);
});

btnSummary.addEventListener('click', function() {
    showSummary();
    const month = new URLSearchParams(window.location.search).get('month') || 'this';
    window.history.replaceState({}, '', `/?month=${month}`);
});


    // Start with Add New Expense visible
    showAdd();

    // Structured form reveal logic
    const btnShowStructured = document.getElementById('btn-show-structured');
    const structuredWrapper = document.getElementById('structured-wrapper');

    btnShowStructured.addEventListener('click', () => {
        structuredWrapper.style.display = 'block';
        btnShowStructured.style.display = 'none';
    });

    // --- Monthly bar chart using Chart.js ---
    const categoryLabels = {{ category_totals.keys() | list | tojson }};
    const categoryValues = {{ category_totals.values() | list | tojson }};

    const baseColors = [
        'rgba(75, 192, 192, 0.7)',
        'rgba(255, 99, 132, 0.7)',
        'rgba(255, 205, 86, 0.7)',
        'rgba(54, 162, 235, 0.7)',
        'rgba(153, 102, 255, 0.7)',
        'rgba(255, 159, 64, 0.7)',
        'rgba(201, 203, 207, 0.7)',
        'rgba(0, 200, 140, 0.7)',
        'rgba(140, 0, 200, 0.7)'
    ];
    const borderColors = baseColors.map(c => c.replace('0.7', '1'));

    const barColors = categoryLabels.map((_, i) => baseColors[i % baseColors.length]);
    const barBorderColors = categoryLabels.map((_, i) => borderColors[i % borderColors.length]);

    const ctx = document.getElementById('monthlyChart').getContext('2d');
    if (categoryLabels.length > 0) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: categoryLabels,
                datasets: [{
                    label: 'Amount spent',
                    data: categoryValues,
                    backgroundColor: barColors,
                    borderColor: barBorderColors,
                    borderWidth: 1
                }]
            },
            options: {
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return value.toString();
                            }
                        }
                    }
                }
            }
        });
    }
</script>
</body>
</html>
